---
title: "adams_mdmc"
format: html
editor: visual
---

# Adams River Modified Double Mass Curve

A modified Double Mass Curve (mDMC) ....

## Adams Watershed Boundary

Utilize hydrometric station catchment area

```{r}
library(sf)
library(bcdata)

gauged_watersheds_search <- bcdc_search("hydrometric watershed") 
View(gauged_watersheds_search)


watersheds_bc <- bcdc_query_geodata(gauged_watersheds_search[[1]]$id, crs = 3005) %>% 
  collect()

adams_gauged_catchment <- filter(watersheds_bc, SOURCE_NAME == "ADAMS RIVER")

adams_catchment_wgs84 <- st_transform(adams_gauged_catchment, crs = "epsg:4326")
```

## Download Climate Data

### Temperature Data

Need temp data on a monthly scale

library(ncdf4)

```{r}
library(ecmwfr)
library(terra)

wf_set_key("2d986593-****-****-****-************", user = "tpowrie@tru.ca")

Year = 1950:2024
Month = sprintf("%02d", 1:12)
adams_coords <- BBOX(adams_catchment_wgs84)
adams_coords

request <- list(
  dataset_short_name = "reanalysis-era5-land-monthly-means",
  format = "netcdf",
  product_type = "monthly_averaged_reanalysis",
  variable = c("2m_temperature"),
  year = Year,
  month = Month,
  time = "00:00",
  area = "52.2/-120.1/50.9/-118.8",
  target = "era_t2m_monthly.nc"
  )

ncfile <- wf_request(
  user = "tpowrie@tru.ca",
  request = request,
  transfer = TRUE,
  path = "C:/Users/taypo/Documents/adams_watershed_hydro/raw_data/",
  verbose = FALSE
)

era_t2m_monthly <- rast("C:/Users/taypo/Documents/adams_watershed_hydro/raw_data/era_t2m_monthly.nc")

# The names for each layer are in UNIX time strings, so converting them into yyyy-mm format will make the layers easier to work with.

time_strings <- gsub(".*valid_time=([0-9\\-]+).*", "\\1", names(era_t2m_monthly))
time_values <- as.numeric(time_strings)
time_dates <- as.POSIXct(time_values, origin = "1970-01-01", tz = "UTC")
year_month <- format(time_dates, "%Y-%m")
names(era_t2m_monthly) <- as.character(year_month)

adams_t2m_rast <- mask(era_t2m_monthly, adams_catchment_wgs84)

adams_t2m_rast <- adams_t2m_rast - 273.15
```

## PET

PET = 0.1651 \* D \* Vd \* K \* N

Vd = 216.7 \* (Vs/Tave + 273.3)

Vs = 6.108 \* exp(17.26939 \* (Tave/Tave + 237.3))

### Daylength Calculation

```{r}
library(suncalc)
library(tidyverse)

# Calculate monthly average of daylength for each grid cell
sun_coords <- xyFromCell(adams_t2m_rast, 1:ncell(adams_t2m_rast))  

sun_dates <- seq.Date(as.Date("1950-01-01"), as.Date("2024-12-31"), by = "month")

sun_times <- lapply(1:nrow(sun_coords), function(i) {
  lat <- sun_coords[i, "y"]
  lon <- sun_coords[i, "x"]
  
  times <- getSunlightTimes(
    date = sun_dates, 
    lat = lat, 
    lon = lon,
    keep = c("sunrise", "sunset") 
  )
  
  time_diff <- difftime(times$sunset, times$sunrise, units = "secs")
  time_diff_hours <- as.numeric(time_diff) / 3600 
  result <- time_diff_hours / 12
  times$time_diff_hours <- time_diff_hours
  times$result_div_12 <- result
  times$month_year <- format(times$sunrise, "%Y-%m")
  
  return(times)
})

sun_times_df <- bind_rows(sun_times)

sun_times_df <- sun_times_df %>%
  select(lat, lon, month_year, result_div_12) %>%
  spread(key = month_year, value = result_div_12) 

daylength_rast <- mask(adams_t2m_rast, adams_t2m_rast)

for (i in 1:nlyr(daylength_rast)) {
  month_name <- names(daylength_rast)[i]
  
  if (month_name %in% names(sun_times_df)) {
    month_mean <- mean(sun_times_df[[month_name]], na.rm = TRUE)
    daylength_rast[[i]] <- ifel(!is.na(adams_t2m_rast[[i]]), month_mean, NA)
  }
}
```

### Hamon PET

```{r}
time_period <- seq(as.Date("1950-01-01"), as.Date("2024-12-01"), by = "month")

days_per_month <- as.integer(format(as.Date(time_period, "%Y-%m-%d") + lubridate::days_in_month(time_period) - 1, "%d"))

vs_rast <- 6.108 * exp(17.26939 * (adams_t2m_rast / (adams_t2m_rast + 237.3)))

vd_rast <- 216.7 * (vs_rast / (adams_t2m_rast + 273.3))

pet_hamon <- daylength_rast * NA

for (i in 1:nlyr(daylength_rast)) {
  pet_hamon[[i]] <- 0.1651 * daylength_rast[[i]] * vd_rast[[i]] * 1.3 * days_per_month[i]
}
```

## AET

### Precipitation Data

```{r}
library(ncdf4)

###

# import cdsapi

# client = cdsapi.Client()

# for year in range(1950, 2025):
  # client.retrieve(
    # 'reanalysis-era5-land',
    # {
        # 'variable': 'total_precipitation',
        # 'year': str(year),
        # 'month': [f"{m:02d}" for m in range(1, 13)]
        # 'day': [f"{d:02d}" for d in range(1, 32)],
        # 'time': [f"{h:02d}:00" for h in range(24)],
        # 'data_format': "netcdf",
        # 'download_format': "zip",
        # 'area': [52.2, -120.1, 50.9, -118.8]
    # },
  # )

###

ppt_dir <- "C:/Users/taypo/Documents/adams_watershed_hydro/raw_data/era_precip_hourly"

ppt_files <- list.files(ppt_dir, pattern = "data_\\d{4}\\.nc$", full.names = TRUE)

ppt_monthly_rasters <- list()

for (file in ppt_files) {
  r <- rast(file)
  
  time_strings <- gsub(".*valid_time=(-?[0-9]+).*", "\\1", names(r))
  time_values <- as.numeric(time_strings)
  time_dates <- as.POSIXct(time_values, origin = "1970-01-01", tz = "UTC")
  year_month <- format(time_dates, "%Y-%m")
  monthly_sum <- tapp(r, index = year_month, fun = sum, na.rm = TRUE)
  names(monthly_sum) <- unique(year_month)
  ppt_monthly_rasters[[file]] <- monthly_sum
}

era_ppt_monthly <- rast(ppt_monthly_rasters)

adams_ppt_rast <- mask(era_ppt_monthly, adams_catchment_wgs84)

adams_ppt_rast <- adams_ppt_rast * 100
plot(adams_ppt_rast[[1]])
```

### Zhang's AET

```{r}
install.packages("remotes")
remotes::install_github("rpkgs/hydroTools")

aet_budyko <- hydroTools::ET_budyko(pet_hergreaves, ppt_raster_array, par = 2, method = "Fu1981")
aet_Zhang <- hydroTools::ET_budyko(pet_hamon, adams_ppt_rast, par = 2, method = "Zhang2001")

layer_dates <- as.Date(paste0(names(aet_Zhang), "-01"))

hydro_years <- ifelse(format(layer_dates, "%m") >= "10",
                      as.numeric(format(layer_dates, "%Y")) + 1,  
                      as.numeric(format(layer_dates, "%Y")))    

hydro_years <- as.factor(hydro_years)

aet_hydro_sum <- tapp(aet_Zhang, index = hydro_years, fun = sum, na.rm = TRUE)

aet_hydro_year <- global(aet_hydro_sum, fun = mean, na.rm = TRUE)
```

## Effective PPT

```{r}

ppt_names <- names(adams_ppt_rast)

years <- str_extract(ppt_names, "(?<=data_)[0-9]{4}")

# Extract the numeric month index (from _1, _2, etc.)
months <- str_extract(ppt_names, "_[0-9]+$")  # Extracts "_1", "_2", etc.
months <- str_remove(months, "_")  # Remove the underscore
months <- sprintf("%02d", as.numeric(months))  # Convert to two-digit month format

# Combine into "YYYY-MM"
year_month <- paste0(years, "-", months)

# Assign the cleaned names
names(adams_ppt_rast) <- year_month


layer_dates <- as.Date(paste0(names(adams_ppt_rast), "-01"))

hydro_years <- ifelse(format(layer_dates, "%m") >= "10",
                      as.numeric(format(layer_dates, "%Y")) + 1,  
                      as.numeric(format(layer_dates, "%Y")))    

hydro_years <- as.factor(hydro_years)

adams_ppt_hydro_sum <- tapp(adams_ppt_rast, index = hydro_years, fun = sum, na.rm = TRUE)

ppt_hydro_year <- global(adams_ppt_hydro_sum, fun = mean, na.rm = TRUE)

adams_pae <- ppt_hydro_year - aet_hydro_year
```

## Annual discharge

```{r}
library(tidyhydat)
download_hydat()

hy_stn_data_coll("08LD001")

adams_hydro_data <- hy_daily_flows("08LD001")

adams_hydro_daily <- adams_hydro_data %>% 
  mutate(Discharge = (Value * 86400 * 1000)/3210000000) # 3,210,000,000 is the aea of the Adams watershed in m^2

adams_hydro_years <- adams_hydro_daily %>%
  mutate(
    hydro_year = ifelse(month(Date) >= 10, year(Date) + 1, year(Date))
  ) %>% 
  group_by(hydro_year) %>%
  filter(!any(is.na(Discharge))) %>%  
  summarise(annual_discharge = sum(Discharge)) %>% 
  slice(1:(n() - 1))
```

## Filter Data

```{r}
adams_hydro_years <- adams_hydro_years %>% 
  filter(hydro_year >= 1951)

adams_pae$hydro_year <- 1950:2025

valid_years <- adams_hydro_years %>%
  select(hydro_year) %>%
  distinct() %>%
  pull(hydro_year)

# Filter the precipitation dataset to match valid discharge time series
adams_pae_filtered <- adams_pae %>%
  filter(hydro_year %in% valid_years)

adams_mdmc_df <- bind_cols(adams_hydro_years, adams_pae_filtered) %>% 
  select(-4) %>% 
  rename(
    hydro_year = `hydro_year...1`,
    annual_ppt = 'mean'
  ) 


```

## mDMC Curve

```{r}
library(ggplot2)

mdmc_cumulative <- adams_mdmc_df %>%
  mutate(
    Cumulative_PPT = cumsum(annual_ppt),  
    Cumulative_Discharge = cumsum(annual_discharge)  
  )

write.csv(mdmc_cumulative, "D:/adams_mDMC_2025/adams_mdmc_2025.csv")

ggplot(mdmc_cumulative, aes(x = Cumulative_PPT, y = Cumulative_Discharge)) +
  geom_line() + 
  labs(
    title = "Modified Double Mass Curve",
    x = "Cumulative Effective Precipitation (mm)",
    y = "Cumulative Discharge (mm)"
  )
```

## Stats

```{r}
library(forecast)
library(trend)

mdmc_slope_groups <- mdmc_cumulative %>%
  mutate(TimeStep = (hydro_year - 1951) %/% 5 + 1)

mdmc_slope_data <- mdmc_slope_groups %>%
  group_by(TimeStep) %>%  
  summarize(
    StartYear = min(hydro_year),  
    EndYear = max(hydro_year),    
    Slope = coef(lm(Cumulative_Discharge ~ Cumulative_PPT))[2]  
  )

print(mdmc_slope_data)

mdmc_slope_data <- mdmc_slope_data %>% drop_na(Slope)

ggplot(mdmc_slope_data, aes(x = StartYear, y = Slope)) +
  geom_line() +
  geom_point() +
  labs(
    title = "MDMC Slope Over 3-Year Intervals",
    x = "Start Year of 3-Year Interval",
    y = "MDMC Slope"
  )

ar1_model <- Arima(mdmc_slope_data$Slope, order = c(1, 0, 0))
mdmc_slope_data$slope_prewhitened <- residuals(ar1_model)

# Check autocorrelation
acf(mdmc_slope_data$slope_prewhitened, main = "ACF of Pre-Whitened MDMC Slope")

# Perform the Pettitt test on the pre-whitened MDMC slope
pettitt_test <- pettitt.test(mdmc_slope_data$slope_prewhitened)

# View the test results
print(pettitt_test)

breakpoint <- pettitt_test$estimate

reference_period <- mdmc_slope_data[1:breakpoint, ] 
disturbance_period <- mdmc_slope_data[(breakpoint + 1):nrow(mdmc_slope_data), ]

# Perform a non-parametric Mann-Whitney U test
wilcox_test <- wilcox.test(
  reference_period$slope_prewhitened,
  disturbance_period$slope_prewhitened
)
print(wilcox_test)
```

## Linear Reg

```{r}
undisturbed_reg <- mdmc_cumulative %>%
  filter(hydro_year >= 1951 & hydro_year <= 1980)

lm_model <- lm(Cumulative_Discharge ~ Cumulative_PPT, data = undisturbed_reg)

summary(lm_model)

mdmc_cumulative$predicted_discharge <- predict(lm_model, newdata = mdmc_cumulative)

ggplot(mdmc_cumulative, aes(x = Cumulative_PPT, y = Cumulative_Discharge)) +
  geom_point(alpha = 0.6) +  
  geom_line(
    aes(y = predicted_discharge),  
    color = "red",
    linetype = "dashed",
    linewidth = 1.2  
  ) +
  labs(
    title = "mDMC for Adams Watershed (1950 - 2023)",
    x = "Cumulative Effective Precipitation (mm)",
    y = "Cumulative Discharge (mm)"
  )
```
